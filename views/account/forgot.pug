doctype html
html
    head
        meta(charset='utf-8')
        meta(http-equiv='X-UA-Compatible', content='IE=edge')
        meta(name='viewport', content='width=device-width, initial-scale=1.0')
        meta(name='theme-color' content='#4DA5F4')
        meta(name='csrf-token', content=_csrf)
        title #{title}
        link(rel='shortcut icon', href='/images/favicon.png')
        link(rel='stylesheet', href='/css/main.css')

    body
        include ../partials/header

        .container
            include ../partials/flash
                .col-sm-8.col-sm-offset-2
                    form(method="POST", action="/v1/auth/forgot-password/reset/?token=" + token)
                        legend Reset password
                        input(type='hidden', name='_csrf', value=_csrf)
                        input(type='hidden', name='_method', value="PATCH")
                        .form-group
                            p Hello
                                if user.username
                                    | , #{user.username}
                                else if user.profile.firstName
                                    | , #{user.profile.firstName}
                                else if user.email
                                    | , #{user.email}

                            p Please enter your new password
                            label.control-label(for='password') New password
                            input.form-control(type='password', name='password', id='password', placeholder='Password', autofocus)
                            p.help-block
                        .form-group
                            label.control-label(for='password-confirm') Confirm new password
                            input.form-control(type='password', name='password-confirm', id='password-confirm', placeholder='Confirm password')
                            p.help-block
                        .form-group.text-center
                            button.btn.btn-primary(type='submit')
                                i.fa.fa-key
                                | Reset Password

        include ../partials/footer

        script(src='/js/lib/jquery-3.1.1.min.js')
        script(src='/js/lib/bootstrap.min.js')
        script(src='/js/main.js')
        script(type="text/javascript").
            $(function() {
                var validations = !{JSON.stringify(validations).replace(/<\//g, "<\\/")}

                console.log(validations);

                $("input[type='password']").on("change", function () {
                    validatePasswords();
                });

                $("form").on("submit", function (e) {
                    var validationSuccess = validateLengths();

                    if ( validationSuccess ) {
                        validationSuccess = validatePasswords();
                    }

                    if ( ! validationSuccess ) {
                        e.preventDefault();
                    }
                });

                function validateLengths() {
                    const passwordField = $("input[name='password']");
                    const passwordHelp = passwordField.siblings(".help-block");
                    const passwordParent = passwordField.parent();
                    const passwordConfirmField = $("input[name='password-confirm']");

                    const password = passwordField.val();
                    const passwordConfirm = passwordConfirmField.val();

                    if ( ! password || ! passwordConfirm ) {
                        return false;
                    }

                    if ( password.length < validations.password.minLength ) {
                        passwordParent.addClass("has-error");
                        passwordHelp.text("Password is too short");

                        return false;
                    }
                    else if (password.length > validations.password.maxLength) {
                        passwordParent.addClass("has-error");
                        passwordHelp.text("Password is too long");

                        return false;
                    }
                    else {
                        passwordParent.removeClass("has-error");
                        passwordHelp.text("");

                        return true;
                    }
                }

                function validatePasswords() {
                    const passwordField = $("input[name='password']");

                    const passwordConfirmField = $("input[name='password-confirm']");
                    const passwordConfirmHelp = passwordConfirmField.siblings(".help-block");
                    const passwordConfirmParent = passwordConfirmField.parent();

                    const password = passwordField.val();
                    const passwordConfirm = passwordConfirmField.val();

                    if ( ! password || ! passwordConfirm ) {
                        return false;
                    }

                    if ( password !== passwordConfirm ) {
                        passwordConfirmParent.addClass("has-error");
                        passwordConfirmHelp.text("Password doesn't match");

                        return false;
                    }
                    else {
                        passwordConfirmParent.removeClass("has-error");
                        passwordConfirmHelp.text("");

                        return true;
                    }
                }
            })